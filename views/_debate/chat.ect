<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link rel="stylesheet" href="/tmp/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="/tmp/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
    <![endif]-->
    <script src="/tmp/angular.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/tmp/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="/tmp/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <!--
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.6/angular-animate.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.6/angular-touch.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/1.3.3/ui-bootstrap.min.js"></script>
    -->

    <script type="text/javascript" src="/tmp/angular-route.min.js"></script>

</head>
<body ng-app="myApp">
<div ng-controller="myCtr" class="container">
<setting-part ng-show="debateInfo.setting != 1"  setting-info="settingInfo" set-up="setUp()"></setting-part>
<div class="row">
<my-navy></my-navy>
</div>

<div class="row">
<ul class="nav nav-pills nav-justified">
    <li role="presentation" class="{{changeTabVal[0]}}"><a ng-click="changeTab(0)">討論情報</a></li>
    <li role="presentation" class="{{changeTabVal[1]}}"><a ng-click="changeTab(1)">主張履歴</a></li>
    <li role="presentation" class="{{changeTabVal[2]}}"><a ng-click="changeTab(2)">分析履歴</a></li>
</ul>

</div>

<div>
<div class="row" ng-show="changeTabVal[0] == 'active'">
   <table class="table table-striped ">
     <!-- On rows -->
     <tr class="info"><th>テーマ</th><td>information</td><td></td></tr>

     <tr class="active">
     <th>肯定側</th>
     <td>{{debateInfo.pro}}</td>
     <td>
            <div ng-if="debateInfo.status<0">
             <div ng-if="debateInfo.position == 1">
                <button ng-click="prepare()" class="btn btn-info" ng-if="debateInfo.proPrepare != 1">準備</button>
                <span ng-if="debateInfo.proPrepare == 1">準備済み</span>
             </div>

             <div ng-if="debateInfo.position == 2">
                <span ng-if="debateInfo.proPrepare == 1">準備済み</span>
                <span ng-if="debateInfo.proPrepare != 1">未準備</span>
             </div>
            </div>

            <div ng-if="debateInfo.status>=0">
                討論中
            </div>
     </td>
     </tr>

     <tr class="success">
     <th>否定側</th>
     <td>{{debateInfo.con}}</td>
     <td>
          <div ng-if="debateInfo.status<0">
          <div ng-if="debateInfo.position == 2">
             <button ng-click="prepare()" class="btn btn-info" ng-if="debateInfo.conPrepare != 1">準備</button>
             <span ng-if="debateInfo.conPrepare == 1">準備済み</span>
          </div>

          <div ng-if="debateInfo.position == 1">
             <span ng-if="debateInfo.conPrepare == 1">準備済み</span>
             <span ng-if="debateInfo.conPrepare != 1">未準備</span>
          </div>
          </div>

            <div ng-if="debateInfo.status>=0">
                討論中
            </div>

     </td>
     </tr>

     <tr class="warning"><th>回数</th><td>{{debateInfo.config.timeNumbers}}</td><td></td></tr>
     <tr class="danger"><th>時間制限</th><td>{{debateInfo.config.timeLimitValDefault}}</td><td></td></tr>
   </table>
</div>

<div class="row" ng-show="changeTabVal[1] == 'active'">

        <div ng-repeat="(key,val) in statement track by $index">
        <div ng-class="(val.position == 1)? 'panel-info':'panel-success'" class="panel">
          <div class="panel-heading">主張</div>
          <div class="panel-body">
                主張内容:{{val.content}}
          </div>
        </div>
        </div>
</div>

<div class="row" ng-show="changeTabVal[2] == 'active'">



    <div ng-repeat="(key,val) in analysis track by $index">
    <div ng-repeat="(_key,_val) in val.obj track by $index">
    <div class="row">
                            <div class="col-sm-1">
                                <div ng-class="(val.position == 1)? 'panel-info':'panel-success'" class="panel">
                               <div class="panel-heading">
                                 主張
                               </div>
                             </div>
                             </div>

                             <div class="col-sm-10">
                             <div class="panel panel-default">
                                 <div class="panel-body">
                                    主張内容:{{_val.claimTxt}}
                                 </div>
                             </div>
                             </div>

                                <div ng-if="_val.dissent == 1" class="col-sm-1" style="line-height:50px;">
                                   <button class="btn btn-danger">意義</button>
                                </div>

    </div>
    <div ng-repeat="(__key,__val) in _val.warrant track by $index">
    <div class="row">
                            <div class="col-sm-1 col-sm-offset-1">
                            <div ng-class="(val.position == 1)? 'panel-info':'panel-success'" class="panel">
                               <div class="panel-heading">
                                 論拠
                               </div>
                             </div>
                             </div>

                             <div class="col-sm-9">
                             <div class="panel panel-default">
                                 <div class="panel-body">
                                    論拠内容:{{__val.warrantTxt}}
                                 </div>
                             </div>
                             </div>

                                <div ng-if="__val.dissent == 1" class="col-sm-1" style="line-height:50px;">
                                   <button class="btn btn-danger">意義</button>
                             </div>
    </div>

    <div ng-repeat="(___key,___val) in __val.evidence track by $index">
    <div class="row">
                            <div class="col-sm-1 col-sm-offset-2">
                            <div ng-class="(val.position == 1)? 'panel-info':'panel-success'" class="panel">
                               <div class="panel-heading">
                                 根拠
                               </div>
                             </div>
                             </div>

                             <div class="col-sm-8">
                             <div class="panel panel-default">
                                 <div class="panel-body">
                                    根拠内容:{{___val.evidenceTxt}}
                                 </div>
                             </div>
                             </div>

                                <div ng-if="___val.dissent == 1" class="col-sm-1" style="line-height:50px;">
                                   <button class="btn btn-danger">意義</button>
                             </div>

    </div>

    </div>
    </div>
    </div>
    </div>
    </div>
</div>
<div class="row">
    <ul class="nav nav-pills nav-justified">
        <li role="presentation" class="{{changeFormVal[0]}}"><a ng-click="changeForm(0)">分析入力</a></li>
        <li role="presentation" class="{{changeFormVal[1]}}"><a ng-click="changeForm(1)">主張入力</a></li>
    </ul>

<br/>
    <ul class="nav nav-pills nav-justified" ng-if="changeFormVal[0] == 'active'">
        <li role="presentation" class="{{changeAnalysisFormVal[0]}}"><a ng-click="changeAnalysisForm(0)">分析します</a></li>
        <li role="presentation" class="{{changeAnalysisFormVal[1]}}"><a ng-click="changeAnalysisForm(1)">再投稿のお願いします</a></li>
    </ul>
</div>

<div class="row">
<my-form ng-if="changeFormVal[0] == 'active' && changeAnalysisFormVal[0] == 'active'" obj="obj" addClaim="addClaim"></my-form>
<my-input-form input-message="inputMessage" ng-if="changeFormVal[1] == 'active' && changeAnalysisFormVal[0] == 'active'"></my-input-form>
<my-input-request-form ng-if="changeFormVal[0] == 'active' && changeAnalysisFormVal[1] == 'active'"  request-statement-message="requestStatementMessage"></my-input-request-form>

<wait-for-confirm ng-if="waitForConfirmVal[0] == 'active'"></wait-for-confirm>
<give-with-confirm ng-if="waitForConfirmVal[1] == 'active'"></give-with-confirm>
</div>

</div>
</body>
<script>

    var myApp = angular.module("myApp",[])

    myApp.factory('coreSocket', function($rootScope) {
                //var socket = io.connect();
                var socket = io(window.location.host + "/_chat").connect()
                return {
                    on: function(eventName, callback) {
                        socket.on(eventName, function() {
                            var args = arguments;
                            $rootScope.$apply(function() {
                                callback.apply(socket, args);
                            });
                        });
                    },
                    emit: function(eventName, data, callback) {
                        socket.emit(eventName, data, function() {
                            var args = arguments;
                            $rootScope.$apply(function() {
                                if (callback) {
                                    callback.apply(socket, args);
                                }
                            });
                        });
                    }
                };
    });

    myApp.factory("myPost",function($http){
        return{
            postData:function(url,data){
                return $http.post(url,data).success(function(res){
                   return res;
                })
            }
        }
    })

    myApp.controller("myCtr",function($scope,coreSocket,myPost){

            function init(){
                coreSocket.emit("enterRoom",{})
                getDebateInformation()
            }

            init()

            function getDebateInformation(){
                myPost.postData("/_debate/getDebateInformation").then(function(_res){
                    console.log(_res)
                    $scope.debateInfo.pro = _res.data.pro
                    $scope.debateInfo.con = _res.data.con
                    $scope.debateInfo.finish = _res.data.finish
                    $scope.debateInfo.setting = _res.data.setting
                    $scope.debateInfo.group = _res.data.group
                    $scope.debateInfo.proPrepare = _res.data.proPrepare
                    $scope.debateInfo.conPrepare = _res.data.conPrepare
                    $scope.debateInfo.position = _res.data.position
                    $scope.debateInfo.status = _res.data.status
                    $scope.debateInfo.config = _res.data.config

                })
            }

            coreSocket.on("enterRoom",function(_res){
                console.log(_res)
            })

            coreSocket.on("systemSettingFinish",function(_res){
                $scope.debateInfo.setting = 1
                $scope.debateInfo.config = {timeNumbers:_res.timeNumbers,timeLimit:_res.timeLimit,timeLimitValDefault:_res.timeLimitValDefault,timeLimitValCustomize:_res.timeLimitValCustomize}
            })

            coreSocket.on("prepared",function(_res){
                getDebateInformation()
            })

            coreSocket.on("prepareCompelete",function(_res){
                getDebateInformation()
            })

            coreSocket.on("receiveStatement",function(_res){
                getDebateInformation()
                $scope.statement = $scope.statement.concat(_res)
            })

             coreSocket.on("requestStatement",function(_res){
                 getDebateInformation()
             })

             coreSocket.on("receiveAnalysis",function(_res){
                 getDebateInformation()
                 $scope.analysis.push(_res)
                 console.log($scope.obj)
             })



             coreSocket.on("receiveConfirm",function(_res){
                 getDebateInformation()
                 $scope.giveWithSubmitResult = _res.giveWithSubmitResult
                 $scope.giveWithSubmitMsg = _res.giveWithSubmitMsg
             })
            $scope.$watch("debateInfo.status",function(val,preVal){
                if(parseInt(preVal) == -2 && parseInt(val) == 0 && parseInt($scope.debateInfo.position) == 1){
                    alert(1)
                    $scope.changeFormVal = ["","active"]
                }

                if(parseInt(preVal) == 0 && parseInt(val) == 1){

                    if(parseInt($scope.debateInfo.position) == 1){
                        $scope.changeFormVal = ["",""]
                    }else{
                        $scope.changeFormVal = ["active",""]
                    }
                }

                if(parseInt(preVal) == 1 && parseInt(val) == 0){

                    if(parseInt($scope.debateInfo.position) == 1){
                        $scope.changeFormVal = ["","active"]
                    }else{
                        $scope.changeFormVal = ["",""]
                    }
                }

                if(parseInt(preVal) == 1 && parseInt(val) == 2){

                    if(parseInt($scope.debateInfo.position) == 1){
                        $scope.changeFormVal = ["",""]
                        $scope.waitForConfirmVal = ["","active"]
                    }else{
                        $scope.changeFormVal = ["",""]
                        $scope.waitForConfirmVal = ["active",""]
                    }
                }

                if(parseInt(preVal) == 2 && parseInt(val) == 1){

                    if(parseInt($scope.debateInfo.position) == 1){
                        $scope.waitForConfirmVal = ["",""]
                    }else{
                        $scope.waitForConfirmVal = ["active",""]
                    }
                }

            })

            $scope.changeTabVal = ["active","",""]
            $scope.changeFormVal = ["",""]
            $scope.changeAnalysisFormVal = ["active",""]
            $scope.waitForConfirmVal = ["",""]


            $scope.changeTab = function(n){
                for(var i=0;i<$scope.changeTabVal.length;i++){
                    $scope.changeTabVal[i] = ""
                }
                $scope.changeTabVal[n] = "active"
            }

            $scope.changeForm = function(n){
                for(var i=0;i<$scope.changeFormVal.length;i++){
                    $scope.changeFormVal[i] = ""
                }
                $scope.changeFormVal[n] = "active"
            }

            $scope.changeAnalysisForm = function(n){
                for(var i=0;i<$scope.changeAnalysisFormVal.length;i++){
                    $scope.changeAnalysisFormVal[i] = ""
                }
                $scope.changeAnalysisFormVal[n] = "active"
            }

            $scope.testValue = "testValue"

            $scope.obj=[{
                                        "claimTxt": "",
                                        "dissent":0,
                                        "warrant": [
                                          {
                                            "warrantTxt": "",
                                            "evidence": [
                                              {
                                                "evidenceTxt": "",
                                                "dissent":0
                                             }

                                           ],
                                           "dissent":0
                                         }
                                       ]
                        }]


            $scope.inputMessage = [
                        {title:"this is the message for statement",dissent:0,content:""}
                    ]

            $scope.requestStatementMessage = ""

            $scope.statement = [
                 {title:"this is the message for statement",dissent:0,content:"this is the message for statement"}
            ]

            $scope.analysis = []

            $scope.settingInfo = {
                timeNumbers:5,
                timeLimit:0,
                timeLimitValDefault:"",
                timeLimitValCustomize:""
            }

            $scope.debateInfo = {
                pro:"",
                con:"",
                finishi:"",
                setting:"",
                group:"",
                config:{},
                proPrepare:0,
                conPrepare:0
            }

            $scope.setUp = function(){
                coreSocket.emit("debateSetting",$scope.settingInfo)
            }

            $scope.prepare = function(){
                coreSocket.emit("prepare",{})
            }


    })

    myApp.directive("myNavy",function(){
        return {
            templateUrl:"/_debate/navy.html"
        }
    })


    myApp.directive('myForm',function(coreSocket){

        var claim = {
                           "claimTxt": "",
                           "dissent":0,
                           "warrant": [
                             {
                               "warrantTxt": "",
                               "dissent":0,
                               "evidence": [
                                 {
                                   "evidenceTxt": "",
                                   "dissent":0
                                }

                              ]
                            }
                          ]
                      }

        var warrant = {
               "warrantTxt": "",
               "dissent":0,
               "evidence": [
                 {
                   "evidenceTxt": "",
                   "dissent":0
                }

              ]
        }

        var evidence = {
                 "evidenceTxt": "",
                 "dissent":0
        }

          return{
              controller:function($scope){
                    $scope.addClaim = function(){
                            $scope.obj.push(JSON.parse(JSON.stringify(claim)))
                    }

                    $scope.addWarrant = function(_key,__key){
                            $scope.obj[_key]['warrant'].push(JSON.parse(JSON.stringify(warrant)))
                    }

                    $scope.addEvidence = function(_key,__key){
                            $scope.obj[_key]['warrant'][__key]['evidence'].push(JSON.parse(JSON.stringify(evidence)))

                    }

                    $scope.removeClaim = function(_key){
                            $scope.obj.splice(_key,1)
                    }

                    $scope.removeWarrant = function(_key,__key){
                            console.log($scope.obj[_key].warrant.splice(__key,1))
                            console.log($scope.obj)
                    }

                    $scope.removeEvidence = function(_key,__key,___key){
                            $scope.obj[_key].warrant[__key].evidence.splice(___key,1)
                    }

                    $scope.submit = function(){
                        coreSocket.emit("giveAnalysis",{obj:$scope.obj})
                    }

              },
              scope:{
                obj:"="
              },
              templateUrl:"/angularTemplate/form.html"
          }
    })

    myApp.directive("myInputForm",function(coreSocket){
        return {
           scope:{
            inputMessage:"="
           },
           controller:function($scope){
                $scope._submit = function(){
                    coreSocket.emit("giveStatement",$scope.inputMessage)
                }
           },
           templateUrl:"/angularTemplate/inputForm.html"
        }
    })

    myApp.directive("myInputRequestForm",function(coreSocket){
        return{
            scope:{requestStatementMessage:"="},
            controller:function($scope){
                $scope.requestStatement = function(){
                   coreSocket.emit("requestStatement",{msg:$scope.requestStatementMessage})
                }
            },
            templateUrl:"/angularTemplate/inputRequestForm.html"
        }
    })

    myApp.directive("settingPart",function(){
           return {
                scope:{
                    settingInfo:"=",
                    setUp:"&"
                },
                templateUrl:"/_debate/settingPart.html"
           }
    })

    myApp.directive("waitForConfirm",function(){
           return {
                scope:{

                },
                templateUrl:"/angularTemplate/waitForConfirm.html"
           }
    })

    myApp.directive("giveWithConfirm",function(coreSocket){
           return {
                scope:{

                },
                controller:function($scope){
                    $scope.giveWithSubmitResult = 1
                    $scope.giveWithSubmit = function(){
                        coreSocket.emit("giveWithSubmit",{giveWithSubmitResult:$scope.giveWithSubmitResult,giveWithSubmitMsg:$scope.giveWithSubmitMsg})
                    }
                },
                templateUrl:"/angularTemplate/giveWithConfirm.html"
           }
    })

</script>
</html>