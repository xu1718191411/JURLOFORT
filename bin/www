#!/usr/bin/env node
var debug = require('debug')('home');
var app = require('../app');
var fs = require("fs");
var SessionSockets = require('session.socket.io');
var Steps = require("ocsteps") ;
var wwwConfig = require("../config/www.js")

var mongo = require("../model/mongo.js");
var tool = require("../controller/tool.js");
var steps = require('ocsteps');


app.set('port', process.env.PORT || wwwConfig.wwwPort);
console.log("server is listening on port "+wwwConfig.wwwConfig);

//var server = app.listen(app.get('port'), function() {
//  debug('Express server listening on port ' + server.address().port);
//});

var server = require("./server.js").server;


var io = require('socket.io')(server);
var sessionSockets = new SessionSockets(io, app.sessionStore, app.cookieParser);



sessionSockets.on('connection', function (err, socket, session) {
    //your regular socket.io code goes here
    //and you can still use your io object

    var positionArrs = [1,2]

    socket.on('position',function(msg){
        for(var i=0;i<positionArrs.length;i++){
            if(positionArrs[i] != parseInt(msg.position)){
                positionArrs.splice(i,1)
            }
        }

        io.emit("adjustPosition",{positionArrs:positionArrs})

        console.log(positionArrs)
    })


    socket.on("enterRoom",function(msg){
        console.log("enter room session is the following...")
        console.log(session.debateLogin)

        var loginInfo = session.debateLogin
        delete loginInfo['password']
        io.emit("enterRoom",{loginInfo:loginInfo})
    })


    socket.on("prepare",function(msg){
        var prepareInfo = session.debateLogin
        delete prepareInfo['password']
        io.emit("prepare",{prepareInfo:prepareInfo})


        steps(function(){

            mongo.find("debateStatus",{num:1},{},this.hold(function(result){
                var proPrepare = result[0].proPrepare
                var conPrepare = result[0].conPrepare

                if(parseInt(proPrepare) == 1  && parseInt(conPrepare) == 1){

                    // 0 pro 做陈述
                    // 1 con 做分析
                    // 2 con 做陈述
                    // 3 pro 做分析

                    io.emit("allPrepare",{status:0})
                }
            }))


        },function(){
            mongo.update("debateStatus",{num:1},{$set:{status:0}},{},this.hold(function(res){

            }))

        })()
    })


    socket.on("makeStatement",function(msg){

        // 0 pro 做陈述
        // 1 con 做分析
        // 2 con 做陈述
        // 3 pro 做分析
        steps(function(){
            mongo.find("debateStatus",{num:1},{},this.hold(function(result){
                var status = result[0].status
                msg.status = (status + 1)%4
                io.emit("receiveStatement",msg)
                io.emit("DoAnalysis",msg)
                return status;
            }))
        },function(status){
            status = (status + 1)%4
            mongo.update("debateStatus",{num:1},{$set:{status:status}},{},this.hold(function(result){
                console.log(result)
            }))
        })()

    })

    socket.on("makeAnalysis",function(msg){
        steps(function(){
            mongo.find("debateStatus",{num:1},{},this.hold(function(result){
                var status = result[0].status
                msg.status = (status + 1)%4
                io.emit("receiveAnalysis",msg)
                return status;
            }))

        },function(status){
            status = (status + 1)%4
            mongo.update("debateStatus",{num:1},{$set:{status:status}},{},this.hold(function(result){
                console.log(result)
            }))
        })()

    })


    socket.on('disconnect', function(){
        //if(!session){
        //    return;
        //}
        //if(!session.debateLogin){
        //    return;
        //}
        //var num = session.debateLogin.num;
        //var position = session.debateLogin.position
        //
        //if(position == 1){
        //        var update = {$unset:{pro:1}}
        //}else{
        //        var update = {$unset:{con:1}}
        //}
        //
        //mongo.update("debateStatus",{num:num},update,{},function(result){
        //
        //})
        //console.log('user disconnected');
    });

    socket.on('join',function(jsonData){
        var position = jsonData.position
        var num = jsonData.num

        if(position == 1){
            var update = {$set:{pro:session.debateLogin.username}}
        }else{
            var update = {$set:{con:session.debateLogin.username}}
        }

        steps(function(){
            mongo.update("debateStatus",{num:jsonData.num},update,this.hold(function(result){

            }))
        },function(){
            mongo.find("debateStatus",{num:jsonData.num},{},function(result){
                //在session中写入num
                session.debateLogin.num = num
                session.debateLogin.position = position
                session.save()
                socket.broadcast.emit("joined",result[0])
            })
        })()

    })

});



//
//io.on('connection',function(socket){
//
//})