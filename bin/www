#!/usr/bin/env node
var debug = require('debug')('home');
var app = require('../app');
var fs = require("fs");
var SessionSockets = require('session.socket.io');
var Steps = require("ocsteps") ;
var claimFile = require("./claimFile.js");


app.set('port', process.env.PORT || 8000);
console.log("server is listening on port 8000");

var server = app.listen(app.get('port'), function() {
  debug('Express server listening on port ' + server.address().port);
});


var io = require('socket.io')(server);
var sessionSockets = new SessionSockets(io, app.sessionStore, app.cookieParser);



sessionSockets.on('connection', function (err, socket, session) {
    //your regular socket.io code goes here
    //and you can still use your io object


    socket.on('testEvent',function(msg){
        claimFile.write()
        console.log('testEvent'+msg);
        //io.emit('testEvent',msg);
        session.nowStatus = session.user.support+"SendClaim";
        session.save();

        socket.broadcast.emit('testEvent',msg);
        socket.emit('_testEvent',msg);

        if(msg.dissentContentsArr.length>0){
            socket.broadcast.emit('buildDissentInput',msg.dissentContentsArr);
        }
        io.sockets.emit("checkStatus",session.nowStatus);


    })

    socket.on('disconnect', function(){
        console.log('user disconnected');
    });

    socket.on('writeJson',function(jsonData){

        Steps(
            function(){
                fs.writeFile('/Users/xuzhongwei/Dropbox/research_project/home/public/data/d3/tmp.json', jsonData, this.hold(function (err) {
                    if (err) throw err;
                    console.log('It\'s saved!');
                }));
            },function(){
                session.nowStatus = session.user.support+"SendAnalysis";
                session.save();
                io.sockets.emit("checkStatus",session.nowStatus);
            },function(){
                var jsonObject = JSON.parse(jsonData);
                socket.broadcast.emit('receiveAnalysis',jsonObject);
                socket.emit('sendAnalysis',jsonObject);
            }
        )();

    })

});



//
//io.on('connection',function(socket){
//
//})